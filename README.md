              (amfs: A null-layer stackable file system) 
		                      [VISHAL SAHU] 
 ------------------------------------------------------------------------------
 INTRODUCTION:
 	- In a stackable file system, each VFS-based object at the stackable file
 	system has a link to one other object on the lower file system.
 	- We identify this symbolically as X->X' where "X" is an object at the 
 	upper layer	and X' is an object on the lower layer.  This form of stacking
 	is a single-layer linear stacking.
 	- Amfs detects and prevent attempts to read or write bad files.  A "bad file" is 
	defined as one that contains at least one known malware (e.g., virus) pattern.

 MOTIVATION:
	- To provide enhanced security to underneath native file system.
 	- This prevents any sort of malware(defined in pattern database) to be written/ 
 	read from native file system.

 SECTION 1: PATTERN DATABASE(ioctl based implementation)
 	1.a: Build
 		-User program amfsctl.c is executed, executable is used to add pattern 
 		database file during mount. The source code is available at 
 		hw2-vsahu/fs/amfs/amfsctl.c
 		-During mounting, follow -o pattdb=<file> format strictly. The '=' in 
 		mount time option is used as delimiter to extract pattern db file, hence
 		it must be used as it is. Variation/or using other char may	result in
 		unwanted system behaviour.

	1.b: Running
		-To add pattern
		./amfsctl -a "pattern" "/mount/point/path/"
			- If pattern to be added already exists, error is returned.
		-To remove pattern
		./amfsctl -r "pattern" "/mount/point/path/"
			- If pattern to be removed doesn't exist, error is returned.
		-To list all patterns
		./amfsctl -l "/mount/point/path/"
 
 SECTION 2: FILE SYSTEM OPERATION(s)

	2.a QUARANTINE LOGIC:

		-unlink/ remove/ delete are ovlivious to quarintine status, i.e, user is
		 allowed to remove files as long as he's able to locate them/remembering 
		 their name. 
		-All files maintain GOOD/ BAD/ UNKNOWN status till amfs is mounted. By 
		 default, all files are treated as marked UNKNOWN in beginning.
		

		-When pattern is added:
			- Files marked as BAD continue to remain in BAD state. 
			- Adds pattern to database but doesn't update the status of GOOD
			files untill they are accessed by user.
			- Updated db version. 

		-During remove pattern:
			- Checks only files listed as bad, good ones continue to remain good.
			- Version is maintained to check if files marked as BAD earlier have 
			become good after removal.
			- If the pattern being removed had marked some file as BAD, the file is
			marked as GOOD after removal of pattern. The amfs treats the file now 
			as if it was never opened and it's status is updated to UNKNOWN.
			- Updates db version.

				     _____    ______remove pattern _____   ____add Pattern
				     |   |    |	                        | |   |
				     |   V    V                         | |   V
				     GOOD FILE	                        BAD FILE
				     |   ^    |                         ^ |   ^
				     |___|    |____ add pattern ________| |___|
			remove pattern

		- The unmarked transitions are conditional on the check if the added/removed
		pattern is found in file.


	2.b READING:
		- When user reads a file, content of file is evaluated and if it contains 
		any of malicious content, the being read is quarintined.
		- Subsequent read attempts to files marked as BAD are denied processing.


	2.c WRITING:
		- When user attempts to write to a file, there are 2 cases:
			- File already exists: The file is checked for mal content before new data
			is written.
			- File is newly created: This is normal case. The user buffer is frisked
			for mal content.

	2.d DIRECTORY LISTING:
		- Listing (ls) displays all the files/ directories which are NEVER 
		OPENED since mounting (marked as UNKNOWN) or have been marked GOOD.
		- Hence files containing mal-patterns but never accessed by user are 
		listed when ls is executed.

	2.e REMOVAL/ DELETION:
		- User is permitted to execute remove/delete/unlink command on all files 
		including quarantined files as per permissions set by VFS.

	2.f MOUNTING:
		Use following command:
		mount -t amfs -o pattdb=<patterndb_file> <mounting_path> <mount_point>

	2.g UN-MOUNTING:
		umount -t amfs <mount_point>


 SECTION 3: ASSUMPTIONS
 	- Maximum length of pattern user can have in database is limited by 128 bytes.
 	- The file is listed if it's not accessed by user yet since mounting 
 	irrespective of whether it contains malware or not. 
 	
 SPECIAL	NOTES: 
	- Maximum length (in bytes) of pattern which can occur at boundary of read/write
	buffer is defined in amfs.h as BOUNDARY_LEN.
	- For current implementation, because the pattern size supported is 128 bytes,
	BOUNDARY_LEN is set as 127(at least one charcter is in next buffer).
	- This is done efficiently by keeping only last 127 bytes of current and first
	127 bytes of next buffer in memory. Thus no significant extra computations are
	done.

	- VERSIONING is done to make scanning efficient. I've explained the concept of
	state-machine implemented implemented above in section 2.a. This is done by 
	keeping list of bad files and updating list and thus file's attributes as and
	when pattern database is updated. 

 SECTION 4: MEMORY ALLOCATION AND DEALLOCATION
 	- Pattern database is stored in persistant linked list data structure. User is 
 	advised to keep pattern database accurate and short for less kernel space memory 
 	footprint.
 	- The list containing dentry of quarantined files for versioning.
 	- Both the lists are freed when only amfs is unmounted.
